# Сервер для просмотра фотографий #

## Содержание ##
[Настройки сервера](#Настройки-сервера)

* [Путь к фотобазе](#Путь-к-фотобазе)

* [Поддерживаемые файлы](#Поддерживаемые-файлы)

* [COM-порт](#COM-порт)

[Запросы для сервера](#Запросы-для-сервера)

* [Структура запроса](#Структура-запроса)

* [Контрольная сумма](#Контрольная-сумма)

[Ответы от сервера](#Ответы-от-сервера)

* [Структура ответа](#Структура-ответа)

* [Список кодов ответов](#Список-кодов-ответов)

[Команды](#Команды)

## Настройки сервера ##

---
### Путь к фотобазе ###
Для указания каталога с фотобазой, нужно при инициализации объекта класса `photoAlbumServer` аргументу `inputPathToPhotoBase` передать строку - путь к корневому каталогу фотобазы. Путь может быть абсолютным или относительным. В случае относительного, путь указывается относительно пути, в котором запускается сервер.

Например:

```python
server = photoAlbumServer(inputPathToPhotoBase='./photoBase')
```

По умолчанию используется путь `./photoBase`
### Поддерживаемые файлы ###

Чтобы определить какие типы файлов поддерживаются сервером, нужно при инициализации объекта класса `photoAlbumServer` аргументу `fileExtensions` передать список, состоящий из строк с расширениями файлов. Расширения файлов не регистрозависимые!

Например:

```python
server = photoAlbumServer(fileExtensions=['JPEG', 'gif', 'png'])
```

По умолчанию поддерживаются типы `jpeg, jpg, gif, png`
### COM-порт ###
Сервер принимает и отправляет сообщения через COM-порт. По умолчанию используется порт `COM1` со скоростью `9600` бит/сек.

Для указания собственных параметров установки соединения, нужно при вызове метода `start` указать значения аргументов `portName` и `baudrate`

Например:

```python
server.start(portName='COM1', baudrate=9600)
```

## Запросы для сервера ###

---

### Структура запроса ###


Сервер принимает запросы в виде байтовой последовательности, которая затем декодируется в строку с кодировкой `UTF-8`.

Любой запрос должен иметь две составные части: тело запроса и значение контрольной суммы. Тело запроса должно заканчиваться символами разделения `.ㅤ` (точка с пробелом).

Структуры запроса в зависимости от количества передаваемых аргументов:
* если запрос не содержит аргументов
`КОМАНДА. КОНТРОЛЬНАЯ_СУММА`. 
Например: `pwd. 590A`


* если запрос содержит один аргумент
`КОМАНДА АРГУМЕНТ. КОНТРОЛЬНАЯ_СУММА`. 
Например: `ls dir1. 31A6`


* если запрос содержит более одного аргумента
`КОМАНДА СПИСОК_АРГУМЕНТОВ. КОНТРОЛЬНАЯ_СУММА`
В этом случае аргументы записываются через пробел. 
Например: `auth login1 password1. B4F1`

### Контрольная сумма ###

 Значение контрольной суммы должно быть вычислено по всему телу запроса, включая символы разделения.
 
 Значение контрольной суммы должно состоять из 4 байт!
 
 Для вычисления контрольной суммы по умолчанию используется **функция простой контрольной суммы**, определенная в модуле `CheckSum.py`.
 
 Чтобы использовать собственную функцию контрольной суммы, нужно при инициализации объекта класса `photoAlbumServer` передать аргументу `checkSum` объект-функцию, реализующий вычисление контрольной суммы.
 
 Например:
 
```python
server = photoAlbumServer(checkSum=myChechSum)
```

Если клиент не вставил в запрос значение контрольной суммы, сервер отправляет ответ с кодом `102` (см. раздел **Ответы от сервера**).

Если запрос клиента не прошёл проверку на значение контрольной суммы, сервер отправляет ответ с кодом `199` (см. раздел **Ответы от сервера**).

## Ответы от сервера ##

### Структура ответа ###

Сервер отправляет ответы в виде байтовой последовательности, которая затем должна быть декодирована в строку с кодировкой `UTF-8`.

Любой ответ сервера состоит из тела ответа и значения контрольной суммы, вычисленной по телу ответа. Тело ответа заканчивается символами разделения `.ㅤ` (точка с пробелом).

Любой ответ сервера начинается с трёхзначного кода ответа. В зависимости от него ответ может иметь разную структуру.
* eсли код ответа `000`: `000 СООБЩЕНИЕ. КОНТРОЛЬНАЯ_СУММА`


* eсли код ответа от `100` до `199`: `КОД СЛУЖЕБНОЕ_СООБЩЕНИЕ. КОНТРОЛЬНАЯ_СУММА`


* если код ответа `200`, то в зависимости от отправленной команды ответ может быть: `200 СЛУЖЕБНОЕ_СООБЩЕНИЕ. СООБЩЕНИЕ. КОНТРОЛЬНАЯ_СУММА` или `200 СЛУЖЕБНОЕ_СООБЩЕНИЕ. КОНТРОЛЬНАЯ_СУММА`. Подробнее об ответах на команды см. в разделе **Команды**

### Список кодов ответов ###

| Код ответа |         Служебное сообщение      | Описание | 
|:-----------|:--------------------------------:|  :--- |
| 000        |                                  |Ответ содержит файл|
| 100        |      ERR User is not authorized  | Невозможно выполнить команду, т.к. клиент не авторизован|
| 101        |       ERR Authorisation Error    | Ошибка авторизации|
| 102        |      ERR Invalid command format  | Неверный формат запроса|
| 103        |         ERR Unsupported file     |Запрашиваемый файл не поддерживается сервером|
| 104        |      ERR File could not be sent  | Невозможно отправить файл|
| 149        | ERR Such directory/file is not exist | Запрашиваемого каталога или файла не существует|
| 199        | ERR Checksum verification failed |Ошибка при сравнении контрольной суммы|
| 200        |                  OK              | Команда выполнена успешно     |

## Команды

Для неавторизованного клиента доступны 2 команды: **hello**, **auth**.

После выполнения авторизации с помощью команды **auth** клиенту доступны следующие команды: **pwd**, **ls**, **cd**, **get**, **quit**.

Если клиент отправляет несуществующую команду, сервер возвращает ответ с кодом `102`.

В описании запросов и ответов используются следующие обозначение:
* П - пробел
* СР - символ разделениея
* СС - служебное сообщение
* КС - контрольная сумма

---
<details>
<summary><code>hello</code> - проверка соединения с сервером</summary>

##### Аргументы
> *отсутствуют*

##### Запрос:
> <table>
>    <thead>
>        <tr>
>            <th colspan=3>Структура запроса</th>
>            <th rowspan=2>Размер</th>
>        </tr>
>        <tr>
>            <th>Команда</th>
>            <th>СР</th>
>            <th>КС</th>
>        </tr>
>    </thead>
>    <tbody>
>        <tr>
>            <td><code>hello</code></td>
>            <td><code>. </code></td>
>            <td><code>КС</code></td>
>            <td>15 байт</td>
>        </tr>
>    </tbody>
> </table>

##### Ответ:
> <table>
>    <thead>
>        <tr>
>            <th colspan=7>Структура ответа</th>
>            <th colspan=2>Описание</th>
>        </tr>
>        <tr>
>            <th>Код</th>
>            <th>П</th>
>            <th>СС</th>
>            <th>СР</th>
>            <th>Сообщение</th>
>            <th>СР</th>
>            <th>КС</th>
>            <th>Размер</th>
>            <th>Назначение</th>
>        </tr>
>    </thead>
>    <tbody>
>        <tr>
>            <td><code>200</code></td>
>            <td><code> </code></td>
>            <td><code>OK</code></td>
>            <td><code>. </code></td>
>            <td><code>Hello</code></td>
>            <td><code>. </code></td>
>            <td><code>КС</code></td>
>            <td>19 байт</td>
>            <td>Соединение успешно установлено</td>
>        </tr>
>    </tbody>
> </table>

##### Пример
> *Запрос*
> ```
> hello. 006C
> ```
> *Ответ*
> ```
> 200 OK. Hello. 0054
> ```

Ответ возвращается только в случае установки соединения. Если ответ не приходит на сторону клиенту, необходимо проверить настройки соединения.

</details>

---
<details>
<summary><code>auth</code> - авторизация клиента</summary>

##### Аргументы
> |Название|Тип|Тип данных|Описание|
> |-|-|-|-|
> |`login`|Обязательный|Строка (макс. 20 символов)|Логин клиента|
> |`password`|Обязательный|Строка (макс. 10 символов)|Пароль клиента|

##### Запрос:
> <table>
>    <thead>
>        <tr>
>            <th colspan=4>Структура запроса</th>
>            <th rowspan=2>Размер</th>
>        </tr>
>        <tr>
>            <th>Команда</th>
>            <th>Аргументы</th>
>            <th>СР</th>
>            <th>КС</th>
>        </tr>
>    </thead>
>    <tbody>
>        <tr>
>            <td><code>auth</code></td>
>            <td><code> login password</code></td>
>            <td><code>. </code></td>
>            <td><code>КС</code></td>
>            <td>до 42 байт</td>
>        </tr>
>    </tbody>
> </table>
>
> ❗️Важно помнить, что перед каждый аргументом должен быть пробел.

##### Ответы:
> <table>
>    <thead>
>        <tr>
>            <th colspan=5>Структура ответа</th>
>            <th colspan=2>Описание</th>
>        </tr>
>        <tr>
>            <th>Код</th>
>            <th>П</th>
>            <th>СС</th>
>            <th>СР</th>
>            <th>КС</th>
>            <th>Размер</th>
>            <th>Назначение</th>
>        </tr>
>    </thead>
>    <tbody>
>        <tr>
>            <td><code>200</code></td>
>            <td><code> </code></td>
>            <td><code>OK</code></td>
>            <td><code>. </code></td>
>            <td><code>КС</code></td>
>            <td>12 байт</td>
>            <td>Авторизация прошла успешно</td>
>        </tr>
>        <tr>
>            <td><code>101</code></td>
>            <td><code> </code></td>
>            <td><code>ERR Authorisation Error</code></td>
>            <td><code>. </code></td>
>            <td><code>КС</code></td>
>            <td>33 байт</td>
>            <td>Клиент не зарегистрирован, или неверные логин и пароль</td>
>        </tr>
>        <tr>
>            <td><code>102</code></td>
>            <td><code> </code></td>
>            <td><code>ERR Invalid command format</code></td>
>            <td><code>. </code></td>
>            <td><code>КС</code></td>
>            <td>36 байт</td>
>            <td>В запросе не 2 аргумента</td>
>        </tr>
>    </tbody>
> </table>

##### Пример
> *Запрос*
> ```
> auth user1 myPassword. 000D
> ```
> *Ответ*
> ```
> 200 ОК. 001C
> ```

Проверка существования и корректности введенных логина и пароля проводится по данным в файле `users.txt`. Одна строка в файле - данные об одном пользователе: логин и пароль, разделенные пробелом.

В случае успешного выполнения команды открывается сессия клиента, в которой текущим каталогом клиента является корневой каталог.

Если клиент не зарегистрирован, нужно обратить к администратору сервера для получения логина и пароля.

</details>

---
<details>
<summary><code>pwd</code> - получение пути текущего каталога клиента</summary>

##### Аргументы
> отсутствуют. Если в запросе будут введены аргументы, они никак не будут учтены при обработке запроса.

##### Запрос:
> <table>
>    <thead>
>        <tr>
>            <th colspan=3>Структура запроса</th>
>            <th rowspan=2>Размер</th>
>        </tr>
>        <tr>
>            <th>Команда</th>
>            <th>СР</th>
>            <th>КС</th>
>        </tr>
>    </thead>
>    <tbody>
>        <tr>
>            <td><code>pwd</code></td>
>            <td><code>. </code></td>
>            <td><code>КС</code></td>
>            <td>9 байт</td>
>        </tr>
>    </tbody>
> </table>

##### Ответ:
> <table>
>    <thead>
>        <tr>
>            <th colspan=7>Структура ответа</th>
>            <th colspan=2>Описание</th>
>        </tr>
>        <tr>
>            <th>Код</th>
>            <th>П</th>
>            <th>СС</th>
>            <th>СР</th>
>            <th>Сообщение</th>
>            <th>СР</th>
>            <th>КС</th>
>            <th>Размер</th>
>            <th>Назначение</th>
>        </tr>
>    </thead>
>    <tbody>
>        <tr>
>            <td><code>200</code></td>
>            <td><code> </code></td>
>            <td><code>OK</code></td>
>            <td><code>. </code></td>
>            <td><code>ТЕКУЩИЙ_КАТАЛОГ</code></td>
>            <td><code>. </code></td>
>            <td><code>КС</code></td>
>            <td>до 1024 байт</td>
>            <td>Возвращает путь, в котором находится клиент</td>
>        </tr>
>    </tbody>
> </table>

##### Пример
> *Запрос*
> ```
> pwd. A50A
> ```
> *Ответ*
> ```
> 200 ОК. photoBase\myPhoto. 004A
> ```

Путь `ТЕКУЩИЙ_КАТАЛОГ` всегда начинается с названия корневого каталога.

</details>

---

<details>
<summary><code>ls</code> - просмотр содержимого каталога</summary>

##### Аргументы
> |Название|Тип|Тип данных|Описание|
> |-|-|-|-|
> |`ПУТЬ`|Необязательный|Строка до 1018 символов|Путь к необходимому каталогу, который клиент хочет просмотреть. Должен быть относительным к текущему каталогу клиентаЁ|

##### Описание запроса:
> <table>
>    <thead>
>        <tr>
>            <th colspan=4>Структура запроса</th>
>            <th rowspan=2>Размер</th>
>        </tr>
>        <tr>
>            <th>Команда</th>
>            <th>Аргумент</th>
>            <th>СР</th>
>            <th>КС</th>
>        </tr>
>    </thead>
>    <tbody>
>        <tr>
>            <td><code>ls</code></td>
>            <td><i>нет</i></td>
>            <td><code>. </code></td>
>            <td><code>КС</code></td>
>            <td>8 байт</td>
>        </tr>
>        <tr>
>            <td><code>ls</code></td>
>            <td><code> ПУТЬ</code></td>
>            <td><code>. </code></td>
>            <td><code>КС</code></td>
>            <td>до 1024 байт</td>
>        </tr>
>    </tbody>
> </table>
>
> ❗️Важно помнить, что перед аргументом, если он присутствует, должен быть пробел.

##### Ответы:
> В зависимости от успешности выполнения команды, может отправиться один или два ответа.
>
> *Описание первого ответа:*
> <table>
>    <thead>
>        <tr>
>            <th colspan=7>Структура ответа</th>
>            <th colspan=2>Описание</th>
>        </tr>
>        <tr>
>            <th>Код</th>
>            <th>П</th>
>            <th>СС</th>
>            <th>СР</th>
>            <th>Сообщение</th>
>            <th>СР</th>
>            <th>КС</th>
>            <th>Размер</th>
>            <th>Назначение</th>
>        </tr>
>    </thead>
>    <tbody>
>        <tr>
>            <td><code>200</code></td>
>            <td><code> </code></td>
>            <td><code>OK</code></td>
>            <td><code>. </code></td>
>            <td><code>{КОЛИЧЕСТВО_БАЙТ} bytes</code></td>
>            <td><code>. </code></td>
>            <td><code>КС</code></td>
>            <td>до 1024 байт</td>
>            <td>Команда выполнена успешно. Следует второй ответ</td>
>        </tr>
>        <tr>
>            <td><code>102</code></td>
>            <td><code> </code></td>
>            <td><code>ERR Invalid command format</code></td>
>            <td><code>. </code></td>
>            <td><i>нет</i></td>
>            <td><i>нет</i></td>
>            <td><code>КС</code></td>
>            <td>36 байт</td>
>            <td>В запросе более одного аргумента</td>
>        </tr>
>        <tr>
>            <td><code>149</code></td>
>            <td><code> </code></td>
>            <td><code>ERR Such directory/file is not exist</code></td>
>            <td><code>. </code></td>
>            <td><i>нет</i></td>
>            <td><i>нет</i></td>
>            <td><code>КС</code></td>
>            <td>46 байт</td>
>            <td>В аргументе <code>ПУТЬ</code> записан путь к несуществующему каталогу, относительно текущего каталога клиента.</td>
>        </tr>
>    </tbody>
> </table>
> 
> Если вернулся ответ с кодом 200, следует второй ответ.
> 
> *Описание второго ответа:*
> <table>
>    <thead>
>        <tr>
>            <th colspan=5>Структура ответа</th>
>            <th colspan=2>Описание</th>
>        </tr>
>        <tr>
>            <th>Код</th>
>            <th>П</th>
>            <th>Сообщение</th>
>            <th>СР</th>
>            <th>КС</th>
>            <th>Размер</th>
>            <th>Назначение</th>
>        </tr>
>    </thead>
>    <tbody>
>        <tr>
>            <td><code>000</code></td>
>            <td><code> </code></td>
>            <td><code>СОДЕРЖИМОЕ_КАТАЛОГА</code></td>
>            <td><code>. </code></td>
>            <td><code>КС</code></td>
>            <td><code>КОЛИЧЕСТВО_БАЙТ + 10</code> байт</td>
>            <td>Сообщение содержит список содержимого каталога</td>
>        </tr>
>    </tbody>
> </table>
>
> `КОЛИЧЕСТВО_БАЙТ` - подстрока из первого ответа сервера.

##### Пример
> *Запрос без аргумента*
> ```
> ls. A50A
> ```
> *Запрос с аргументом*
> ```
> ls. A50A
> ```
> *Ответ в случае возникновения ошибки*
> ```
> 149 ERR Such directory/file is not exist. 732D
> ```
> *Ответы при успешном выполнении команды*
> ```
> 200 ОК. 33 bytes. 1287
> ```
> ```
> 000 d-summer f-myPhoto.jpeg. 73EA
> ```

Возвращаемое `СОДЕРЖИМОЕ_КАТАЛОГА` имеет следующую структуру: в нём записаны имена всех файлов и каталогов находящихся в просматриваемом каталоге, разделенные пробелами.
Перед именами каталогов записывается пометка `d-`, перед именами файлов `f-`.

Например, если каталог имеет имя `photos`, то в строке `СОДЕРЖИМОЕ_КАТАЛОГА` он будет записан как `d-photos`, а файл `cat.gif` будет записан как `f-cat.gif`.

Например, каталог содержит следующие каталоги и файлы
```
dir1 
myCatalog 
cache 
myPhoto.jpeg
BIRD.gif
```
то `СОДЕРЖИМОЕ_КАТАЛОГА` будет записано как
```
d-dir1 d-myCatalog d-cache f-myPhoto.jpeg f-BIRD.gif
```

Если каталог пуст, ответы будут следующими:
```
200 OK. 0 bytes. E924
```
```
000 . 26BC
```

</details>

---

### cd

**Назначение:** переход в заданный каталог.

**Аргументы:** путь к каталогу, в которой клиент хочет перейти. Путь должен быть относительным к текущему каталогу клиента.

**Структура запроса:** `cd. ПУТЬ. КОНТРОЛЬНАЯ_СУММА`.

**Структура ответа:** `КОД СЛУЖЕБНОЕ_СООБЩЕНИЕ. КОНТРОЛЬНАЯ_СУММА`.

**Возвращаемые коды:**

* `102`, если в запросе количество аргументов не равно 1.
* `149`, если в аргументе `ПУТЬ` записан путь к несуществующему каталогу, относительно текущего каталога клиента.
* `200`, если ошибок не произошло и осуществлен переход по заданному пути.

**Пример запроса:**
```commandline
cd myPhoto. A50A
```
**Пример ответа:**
```
200 ОК. 01AB
```

Если в аргумент `ПУТЬ` введено `~` будет осуществлён переход в корневой каталог.

В случае успешного выполнения команды, текущий каталог клиента меняется на каталог, который был записан в аргументе.

### get

**Назначение:** скачивание файла с сервера.

**Аргументы:** название файла (включая расширение) в текущем каталоге клиента.

**Структура запроса:** `get НАЗВАНИЕ_ФАЙЛА. КОНТРОЛЬНАЯ_СУММА`.

В случае возникновения ошибки ответ имеет следующую структуру:

**Структура ответа с ошибкой:** `КОД СЛУЖЕБНОЕ_СООБЩЕНИЕ. КОНТРОЛЬНАЯ_СУММА`

В случае успешного выполнения команды отправляются два ответа с задержкой в 1 секунду.

**Структура первого ответа:** `200 OK. File follows - КОЛИЧЕСТВО_БАЙТ bytes. КОНТРОЛЬНАЯ_СУММА`.

`КОЛИЧЕСТВО_БАЙТ` это число - количество байт, которая занимает строка `ФАЙЛ` в следующем ответе.

**Структура второго ответа:** `000 ФАЙЛ. КОНТРОЛЬНАЯ_СУММА`.

**Возвращаемые коды:**

* `102`, если в запросе количество аргументов не равно 1.
* `103`, если запрашиваемый файл имеет не поддерживаемое расширение.
* `104`, если возникла ошибка при открытии или кодировании файла.
* `149`, если в аргументе `НАЗВАНИЕ_ФАЙЛА` записано название несуществующего файла в текущем каталоге клиента.
* `200`, если ошибок не произошло. Следует второй ответ.

**Пример запроса:**
```commandline
get cat.JPEG. 4529
```

**Пример ответа в случае возникновения ошибки:**
```
149 ERR Such directory/file is not exist. 732D
```
**Пример ответов при успешном выполнении команды:**
```
200 ОК. File follows - 49 bytes. 84EF
```
```
000 nia79sd99732bfdosjna4e55w9808hgfs9rhfs00fds0inf0d. 73EA
```

Строка `ФАЙЛ` является закодированным файлом по протоколу **BASE64**.

### quit

**Назначение:** завершении сессии клиента.

**Аргументы:** отсутствуют. Если в запросе будут введены аргументы, они никак не будут учтены при обработке запроса.

**Структура запроса:** `quit. КОНТРОЛЬНАЯ_СУММА`.

**Структура ответа:** `200 ОК. Goodbye!. КОНТРОЛЬНАЯ_СУММА`.

**Пример запроса:**
```commandline
quit. A551
```
**Пример ответа:**
```
200 ОК. Goodbye!. 15DE
```

При выполнении команды сессия клиента завершается. Информация о текущем каталоге клиента завершается. 
Чтобы клиент снова мог просматривать и скачивать содержимое с сервера, ему надо повторно авторизоваться.
